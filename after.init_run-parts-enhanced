#!/bin/sh
#
# after.init: Enhanced version supporting multiple IP list modules
# Original: if executable, called by ufw-init. See 'man ufw-framework' for
#             details. Note that output from these scripts is not seen via the
#             the ufw command, but instead via ufw-init.
#
# Copyright 2013 Canonical Ltd.
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License version 3,
#    as published by the Free Software Foundation.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# ufw-blocklist dynamic edition: IP blocklist extension for Ubuntu ufw
#  https://github.com/poddmo/ufw-blocklist
#
# Install this script executable as /etc/ufw/after.init
# Install user scripts to be run after ufw has initialised into /etc/ufw/after.init.d/
# ** Scripts will run with ufw privilege, ie root **
# Enhanced: Supports both legacy format and enhanced modules with configuration
#
# Script names must match the filename format: numbernumber-*.ufw
# Order of execution is critical. Lower (00) numbered scripts will execute first
# Higher numbered scripts have higher precedence
# Example filenames: 10-ipblocklist-ipsum.ufw, 20-geo-blocklist.ufw
#
# Enhanced module format:
# - Scripts can have companion .conf files for configuration
# - Scripts can be enabled/disabled via configuration files
# - Supports automatic URL downloading and processing
#
set -e

# Load configuration if exists
[ -f /etc/default/ufw-blocklist ] && . /etc/default/ufw-blocklist

afterinitdir='/etc/ufw/after.init.d'
moduledir='/etc/ufw/modules'

# Create module directory if it doesn't exist
[ ! -d "$moduledir" ] && mkdir -p "$moduledir"

# Enhanced run-parts function with module support
runpartsfunc ()
{
    # Load configuration
    [ -f /etc/default/ufw-blocklist ] && . /etc/default/ufw-blocklist

    local action="$1"
    echo "=== UFW Blocklist Module Runner ==="
    echo "Action: $action"
    echo "Module directory: $afterinitdir"
    echo ""

    # Check for module-level scripts first (enhanced mode)
    if [ -d "$moduledir" ]; then
        echo "Scanning enhanced modules in $moduledir..."

        for module in "$moduledir"/*; do
            [ -d "$module" ] || continue

            module_name=$(basename "$module")
            echo ""
            echo "--- Processing module: $module_name ---"

            # Check if module is enabled
            enabled="yes"
            if [ -f "$module/disabled" ]; then
                echo "Module $module_name is disabled"
                enabled="no"
            fi

            # Load module configuration
            if [ -f "$module/module.conf" ]; then
                . "$module/module.conf"
                echo "Loaded configuration for $module_name"
            fi

            # Execute module action
            if [ "$enabled" = "yes" ]; then
                if [ -x "$module/module.sh" ]; then
                    echo "Executing $module_name with action: $action"
                    "$module/module.sh" "$action"
                    result=$?
                    if [ $result -ne 0 ]; then
                        echo "Module $module_name failed with code: $result"
                    else
                        echo "Module $module_name completed successfully"
                    fi
                elif [ -x "$module/$module_name.ufw" ]; then
                    echo "Executing legacy module $module_name with action: $action"
                    "$module/$module_name" "$action"
                    result=$?
                    if [ $result -ne 0 ]; then
                        echo "Module $module_name failed with code: $result"
                    else
                        echo "Module $module_name completed successfully"
                    fi
                else
                    echo "No executable found for module $module_name"
                fi
            fi
        done
    fi

    echo ""
    echo "--- Scanning legacy modules in $afterinitdir ---"

    # Run standard run-parts for legacy scripts
    run-parts --report --regex='^[0-9]{2}-.*.ufw$' --arg="$1" "${afterinitdir}"
    local result=$?

    echo ""
    echo "=== Module execution complete ==="
    echo "Result: $result"

    exit $result
}

# Function to install a new module
install_module()
{
    local module_name="$1"
    local module_type="$2"
    local module_url="$3"

    echo "Installing module: $module_name (type: $module_type)"

    # Create module directory
    local module_path="$moduledir/$module_name"
    mkdir -p "$module_path"

    # Download module script
    if [ -n "$module_url" ] && [ "$module_url" != "local" ]; then
        echo "Downloading module script from: $module_url"
        curl -sS -f "$module_url" -o "$module_path/module.sh"
        chmod 750 "$module_path/module.sh"
    elif [ "$module_url" = "local" ]; then
        echo "Installing module from local file..."
        # This would be handled by the main install script
        return 0
    fi

    # Create module configuration
    cat > "$module_path/module.conf" << EOF
# Module configuration for $module_name
MODULE_NAME="$module_name"
MODULE_TYPE="$module_type"
MODULE_URL="$module_url"
ENABLED="yes"
EOF

    echo "Module $module_name installed successfully"
    echo "Configuration: $module_path/module.conf"
    echo "Executable: $module_path/module.sh"
}

# Function to list available modules
list_modules()
{
    echo "=== Available Modules ==="

    if [ -d "$moduledir" ]; then
        echo "Enhanced modules:"
        for module in "$moduledir"/*; do
            [ -d "$module" ] || continue

            module_name=$(basename "$module")
            if [ -f "$module/disabled" ]; then
                status="disabled"
            else
                status="enabled"
            fi

            if [ -f "$module/module.conf" ]; then
                . "$module/module.conf"
                echo "  $module_name ($MODULE_TYPE) - $status"
                echo "    URL: $MODULE_URL"
            else
                echo "  $module_name (legacy) - $status"
            fi
        done
    fi

    echo ""
    echo "Legacy modules:"
    if [ -d "$afterinitdir" ]; then
        ls -1 "$afterinitdir"/*.ufw 2>/dev/null | while read script; do
            [ -f "$script" ] && echo "  $(basename "$script")"
        done
    fi
}

# Function to enable/disable modules
toggle_module()
{
    local module_name="$1"
    local action="$2"  # enable or disable
    local module_path="$moduledir/$module_name"

    if [ ! -d "$module_path" ]; then
        echo "Module $module_name not found"
        return 1
    fi

    case "$action" in
        enable)
            if [ -f "$module_path/disabled" ]; then
                rm "$module_path/disabled"
                echo "Module $module_name enabled"
            else
                echo "Module $module_name is already enabled"
            fi
            ;;
        disable)
            touch "$module_path/disabled"
            echo "Module $module_name disabled"
            ;;
        *)
            echo "Usage: toggle_module <module_name> <enable|disable>"
            return 1
            ;;
    esac
}

case "$1" in
start)
    runpartsfunc start
    ;;
stop)
    runpartsfunc stop
    ;;
status)
    runpartsfunc status
    ;;
flush-all)
    runpartsfunc flush-all
    ;;
install-module)
    [ $# -lt 4 ] && {
        echo "Usage: $0 install-module <name> <type> <url>"
        exit 1
    }
    install_module "$2" "$3" "$4"
    ;;
list-modules)
    list_modules
    ;;
toggle-module)
    [ $# -lt 3 ] && {
        echo "Usage: $0 toggle-module <name> <enable|disable>"
        exit 1
    }
    toggle_module "$2" "$3"
    ;;
*)
    echo "'$1' not supported"
    echo "Usage: $0 {start|stop|flush-all|status|install-module|list-modules|toggle-module}"
    echo ""
    echo "Enhanced commands:"
    echo "  install-module <name> <type> <url>  - Install a new module"
    echo "  list-modules                           - List all available modules"
    echo "  toggle-module <name> <enable|disable> - Enable/disable a module"
    ;;
esac