#!/bin/bash
#
# UFW 防火墙阻止列表配置管理
# 简单交互式配置菜单
#

set -e

# 配置文件路径
CONFIG_FILE="/etc/default/ufw-blocklist"

# --- 默认配置 ---
load_defaults() {
    THREAT_IPSET="ufw-blocklist-threat"
    GEO_IPSET="ufw-blocklist-cn"
    THREAT_URL="https://raw.githubusercontent.com/stamparm/ipsum/master/levels/3.txt"
    GEO_URL="http://www.ipdeny.com/ipblocks/data/countries/cn.zone"
    ENABLE_THREAT_UPDATE="yes"
    ENABLE_GEO_UPDATE="yes"
    THREAT_UPDATE_FREQ="daily"
    GEO_UPDATE_FREQ="weekly"
    DEFAULT_STRATEGY="conservative"
    LOG_LEVEL="3"
    LOG_PREFIX="[UFW BLOCKLIST]"
}

# --- 加载现有或默认配置 ---
load_config() {
    load_defaults # 从默认设置开始
    if [ -f "$CONFIG_FILE" ]; then
        # 如果配置文件存在，加载它来覆盖默认值
        . "$CONFIG_FILE"
    fi
}

# --- 菜单操作函数 ---

check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo "错误：此脚本必须以 root 权限运行"
        exit 1
    fi
}

show_current_config() {
    echo "--- 当前配置 ---"
    echo "1. THREAT_IPSET: $THREAT_IPSET"
    echo "2. GEO_IPSET: $GEO_IPSET"
    echo "3. THREAT_URL: $THREAT_URL"
    echo "4. GEO_URL: $GEO_URL"
    echo "5. ENABLE_THREAT_UPDATE: $ENABLE_THREAT_UPDATE"
    echo "6. ENABLE_GEO_UPDATE: $ENABLE_GEO_UPDATE"
    echo "7. THREAT_UPDATE_FREQ: $THREAT_UPDATE_FREQ"
    echo "8. GEO_UPDATE_FREQ: $GEO_UPDATE_FREQ"
    echo "9. DEFAULT_STRATEGY: $DEFAULT_STRATEGY"
    echo "---------------------------"
}

edit_config() {
    local var_name="$1"
    local current_value="${!1}" # 间接引用
    read -p "请输入 $var_name 的新值 [$current_value]: " new_value
    # 如果用户只按回车，保持当前值
    if [ -n "$new_value" ]; then
        export "$var_name"="$new_value"
    fi
}

save_configuration() {
    echo "保存配置到 $CONFIG_FILE..."
    {
        echo "# UFW Blocklist Configuration"
        echo "# Generated by ufw-blocklist-config on $(date)"
        echo ""
        echo "THREAT_IPSET=\"$THREAT_IPSET\""
        echo "GEO_IPSET=\"$GEO_IPSET\""
        echo "THREAT_URL=\"$THREAT_URL\""
        echo "GEO_URL=\"$GEO_URL\""
        echo "ENABLE_THREAT_UPDATE=\"$ENABLE_THREAT_UPDATE\""
        echo "ENABLE_GEO_UPDATE=\"$ENABLE_GEO_UPDATE\""
        echo "THREAT_UPDATE_FREQ=\"$THREAT_UPDATE_FREQ\""
        echo "GEO_UPDATE_FREQ=\"$GEO_UPDATE_FREQ\""
        echo "DEFAULT_STRATEGY=\"$DEFAULT_STRATEGY\""
        echo "LOG_LEVEL=\"$LOG_LEVEL\""
        echo "LOG_PREFIX=\"$LOG_PREFIX\""
    } > "$CONFIG_FILE"
    chmod 640 "$CONFIG_FILE"
    echo "配置已保存"
}

# --- 主菜单 ---
main_menu() {
    while true; do
        echo ""
        echo "UFW 阻火墙阻止列表配置"
        show_current_config
        echo "菜单："
        echo "  e - 编辑配置值"
        echo "  r - 重置为默认值"
        echo "  s - 保存并退出"
        echo "  q - 不保存退出"
        echo ""
        read -p "请选择一个选项: " choice

        case "$choice" in
            e)
                read -p "请输入要编辑的设置编号 (1-9): " num
                case "$num" in
                    1) edit_config "THREAT_IPSET" ;;
                    2) edit_config "GEO_IPSET" ;;
                    3) edit_config "THREAT_URL" ;;
                    4) edit_config "GEO_URL" ;;
                    5) edit_config "ENABLE_THREAT_UPDATE" ;;
                    6) edit_config "ENABLE_GEO_UPDATE" ;;
                    7) edit_config "THREAT_UPDATE_FREQ" ;;
                    8) edit_config "GEO_UPDATE_FREQ" ;;
                    9) edit_config "DEFAULT_STRATEGY" ;;
                    *) echo "无效选择。" ;;
                esac
                ;;
            r)
                read -p "确定要重置为默认值吗？(y/N): " confirm
                if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
                    echo "重置为默认值..."
                    load_defaults
                else
                    echo "重置已取消"
                fi
                ;;
            s)
                save_configuration
                break
                ;;
            q)
                read -p "确定要不保存就退出吗？(y/N): " confirm
                if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
                    echo "退出但不保存"
                    break
                else
                    echo "已取消"
                fi
                ;;
            *)
                echo "无效选项。请重试"
                ;;
        esac
    done
}

# --- 脚本执行 ---
check_root
load_config
main_menu

exit 0