#!/bin/bash
#
# UFW Blocklist Configuration Management System
# Interactive configuration setup for enhanced ufw-blocklist functionality
#

set -e

# Colors for better UI
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration file path
CONFIG_FILE="/etc/default/ufw-blocklist"

# Default values
DEFAULT_CONFIG='
# UFW Blocklist Configuration
# Generated by ufw-blocklist-config

# IP Set Names
THREAT_IPSET="ufw-blocklist-threat"
GEO_IPSET="ufw-blocklist-cn"

# Data Sources
THREAT_URL="https://raw.githubusercontent.com/stamparm/ipsum/master/levels/3.txt"
GEO_URL="http://www.ipdeny.com/ipblocks/data/countries/cn.zone"

# Update Configuration
ENABLE_THREAT_UPDATE="yes"
ENABLE_GEO_UPDATE="yes"

# Update Frequency (daily, weekly)
THREAT_UPDATE_FREQ="daily"
GEO_UPDATE_FREQ="weekly"

# Default Installation Strategy
DEFAULT_STRATEGY="conservative"

# Logging
LOG_LEVEL="3"
LOG_PREFIX="[UFW BLOCKLIST]"
'

# Function to print colored output
print_status() {
    local color="$1"
    local message="$2"
    echo -e "${color}${message}${NC}"
}

# Function to check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        print_status "$RED" "Error: This script must be run as root"
        exit 1
    fi
}

# Function to display banner
display_banner() {
    clear
    print_status "$BLUE" "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      UFW Blocklist Configuration Manager               â•‘
â•‘                        Enhanced Edition v2.0                       â•‘
â•‘                                                                      â•‘
â•‘  Configure your Ubuntu firewall with threat intelligence and             â•‘
â•‘  geographic IP blocking capabilities                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo
}

# Function to get user choice
get_user_choice() {
    local prompt="$1"
    local default="$2"
    local choice

    while true; do
        echo -n "$prompt [$default]: "
        read choice
        choice="${choice:-$default}"
        case "$choice" in
            [Yy]|[Nn]) break ;;
            *) echo "Please enter Y/y or N/n" ;;
        esac
    done

    echo "$choice"
}

# Function to get numeric choice
get_numeric_choice() {
    local prompt="$1"
    local min="$2"
    local max="$3"
    local default="$4"
    local choice

    while true; do
        echo -n "$prompt [$default]: "
        read choice
        choice="${choice:-$default}"

        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge "$min" ] && [ "$choice" -le "$max" ]; then
            echo "$choice"
            return
        fi

        echo "Please enter a number between $min and $max"
    done
}

# Function to configure IP set names
configure_ipset_names() {
    print_status "$YELLOW" "ğŸ“¦ Configure IP Set Names"
    echo "These names will be used for the ipset collections"
    echo

    print_status "$GREEN" "Current names:"
    echo "  Threat IP Set: ${THREAT_IPSET:-ufw-blocklist-threat}"
    echo "  Geographic IP Set: ${GEO_IPSET:-ufw-blocklist-cn}"
    echo

    local custom_names=$(get_user_choice "Use custom IP set names? (Y/n)" "n")

    if [[ "$custom_names" =~ ^[Yy] ]]; then
        echo -n "Enter threat IP set name: "
        read THREAT_IPSET
        echo -n "Enter geographic IP set name: "
        read GEO_IPSET
    fi

    print_status "$GREEN" "âœ“ IP set names configured"
    echo
}

# Function to configure data sources
configure_data_sources() {
    print_status "$YELLOW" "ğŸŒ Configure Data Sources"
    echo "Choose which IP sources to enable:"
    echo

    print_status "$BLUE" "1) Threat Intelligence IPs (IPsum)"
    echo "   - Malicious IP addresses from various security sources"
    echo "   - Updated daily from GitHub"
    echo "   - Approximately 13,000+ entries"
    echo

    print_status "$BLUE" "2) Geographic Blocking (China IP ranges)"
    echo "   - All IP ranges allocated to China (CN zone)"
    echo "   - Updated weekly from ipdeny.com"
    echo "   - Approximately 8,000+ CIDR ranges"
    echo

    print_status "$BLUE" "3) Both threat and geographic blocking"
    echo "   - Maximum protection coverage"
    echo "   - Combined ~21,000+ entries"
    echo

    local choice=$(get_numeric_choice "Select data sources (1-3)" 1 3 1)

    case "$choice" in
        1)
            ENABLE_THREAT_UPDATE="yes"
            ENABLE_GEO_UPDATE="no"
            print_status "$GREEN" "âœ“ Threat intelligence enabled"
            ;;
        2)
            ENABLE_THREAT_UPDATE="no"
            ENABLE_GEO_UPDATE="yes"
            print_status "$GREEN" "âœ“ Geographic blocking enabled"
            ;;
        3)
            ENABLE_THREAT_UPDATE="yes"
            ENABLE_GEO_UPDATE="yes"
            print_status "$GREEN" "âœ“ Both threat and geographic blocking enabled"
            ;;
    esac

    echo
}

# Function to configure update frequencies
configure_update_frequencies() {
    print_status "$YELLOW" "â° Configure Update Frequencies"
    echo "Choose how often each data source should be updated:"
    echo

    if [ "$ENABLE_THREAT_UPDATE" = "yes" ]; then
        print_status "$BLUE" "Threat Intelligence Updates:"
        print_status "$BLUE" "1) Daily (recommended)"
        echo "   - Keeps protection current with latest threats"
        echo "   - Higher network overhead but more secure"
        print_status "$BLUE" "2) Weekly"
        echo "   - Lower network overhead"
        echo "   - May miss some newly emerging threats"
        echo

        local threat_freq_choice=$(get_numeric_choice "Select threat update frequency (1-2)" 1 2 1)
        THREAT_UPDATE_FREQ=$([ "$threat_freq_choice" = "1" ] && echo "daily" || echo "weekly")
        print_status "$GREEN" "âœ“ Threat update frequency: $THREAT_UPDATE_FREQ"
        echo
    fi

    if [ "$ENABLE_GEO_UPDATE" = "yes" ]; then
        print_status "$BLUE" "Geographic IP Updates:"
        print_status "$BLUE" "1) Weekly (recommended)"
        echo "   - Geographic allocations change less frequently"
        echo "   - Appropriate update cycle for country blocks"
        print_status "$BLUE" "2) Monthly"
        echo "   - Minimum network overhead"
        echo "   - May miss newly allocated IP ranges"
        echo

        local geo_freq_choice=$(get_numeric_choice "Select geographic update frequency (1-2)" 1 2 1)
        GEO_UPDATE_FREQ=$([ "$geo_freq_choice" = "1" ] && echo "weekly" || echo "monthly")
        print_status "$GREEN" "âœ“ Geographic update frequency: $GEO_UPDATE_FREQ"
        echo
    fi
}

# Function to configure default strategy
configure_default_strategy() {
    print_status "$YELLOW" "âš¡ Configure Default Security Strategy"
    echo "Choose what should be enabled by default after installation:"
    echo

    print_status "$BLUE" "1) Conservative Strategy"
    echo "   - Enable only threat intelligence blocking by default"
    echo "   - Geographic blocking must be manually enabled"
    echo "   - Safer for production environments"
    echo "   - Recommended if unsure"
    echo

    print_status "$BLUE" "2) Complete Strategy"
    echo "   - Enable both threat and geographic blocking by default"
    echo "   - Maximum protection out of the box"
    echo "   - May affect legitimate China-related services"
    echo "   - Recommended for high-security environments"
    echo

    DEFAULT_STRATEGY=$([ "$(get_user_choice "Choose default strategy (1/2)" "1")" = "2" ] && echo "complete" || echo "conservative")
    print_status "$GREEN" "âœ“ Default strategy: $DEFAULT_STRATEGY"
    echo
}

# Function to review configuration
review_configuration() {
    print_status "$YELLOW" "ğŸ“‹ Configuration Review"
    echo "Please review your configuration:"
    echo

    print_status "$BLUE" "IP Sets:"
    echo "  Threat IP Set: $THREAT_IPSET"
    echo "  Geographic IP Set: $GEO_IPSET"
    echo

    print_status "$BLUE" "Data Sources:"
    if [ "$ENABLE_THREAT_UPDATE" = "yes" ]; then
        echo "  âœ“ Threat Intelligence: Enabled (updates: $THREAT_UPDATE_FREQ)"
    else
        echo "  âœ— Threat Intelligence: Disabled"
    fi

    if [ "$ENABLE_GEO_UPDATE" = "yes" ]; then
        echo "  âœ“ Geographic Blocking: Enabled (updates: $GEO_UPDATE_FREQ)"
    else
        echo "  âœ— Geographic Blocking: Disabled"
    fi

    print_status "$BLUE" "Default Strategy: $DEFAULT_STRATEGY"
    echo

    print_status "$BLUE" "Data Sources:"
    echo "  Threat URLs: $THREAT_URL"
    echo "  Geographic URLs: $GEO_URL"
    echo

    local confirm=$(get_user_choice "Proceed with this configuration? (Y/n)" "y")
    if [[ ! "$confirm" =~ ^[Yy] ]]; then
        echo "Configuration cancelled. Please restart the wizard."
        exit 0
    fi
}

# Function to save configuration
save_configuration() {
    local config_content=""
    config_content+="# UFW Blocklist Configuration\n"
    config_content+="# Generated by ufw-blocklist-config on $(date)\n\n"
    config_content+="# IP Set Names\n"
    config_content+="THREAT_IPSET=\"$THREAT_IPSET\"\n"
    config_content+="GEO_IPSET=\"$GEO_IPSET\"\n\n"
    config_content+="# Data Sources\n"
    config_content+="THREAT_URL=\"$THREAT_URL\"\n"
    config_content+="GEO_URL=\"$GEO_URL\"\n\n"
    config_content+="# Update Configuration\n"
    config_content+="ENABLE_THREAT_UPDATE=\"$ENABLE_THREAT_UPDATE\"\n"
    config_content+="ENABLE_GEO_UPDATE=\"$ENABLE_GEO_UPDATE\"\n"
    config_content+="THREAT_UPDATE_FREQ=\"$THREAT_UPDATE_FREQ\"\n"
    config_content+="GEO_UPDATE_FREQ=\"$GEO_UPDATE_FREQ\"\n\n"
    config_content+="# Default Strategy\n"
    config_content+="DEFAULT_STRATEGY=\"$DEFAULT_STRATEGY\"\n\n"
    config_content+="# Logging\n"
    config_content+="LOG_LEVEL=\"$LOG_LEVEL\"\n"
    config_content+="LOG_PREFIX=\"$LOG_PREFIX\"\n"

    echo "$config_content" > "$CONFIG_FILE"
    chmod 640 "$CONFIG_FILE"
    print_status "$GREEN" "âœ“ Configuration saved to $CONFIG_FILE"
}

# Function to show usage
show_usage() {
    echo "Usage: $0 [options]"
    echo "Options:"
    echo "  -h, --help     Show this help message"
    echo "  -i, --interactive Run interactive configuration wizard"
    echo "  -s, --show     Show current configuration"
    echo "  -r, --reset    Reset to default configuration"
    echo
    echo "Examples:"
    echo "  $0 --interactive     # Run configuration wizard"
    echo "  $0 --show           # Show current config"
    echo "  $0 --reset          # Reset to defaults"
}

# Function to show current configuration
show_configuration() {
    if [ -f "$CONFIG_FILE" ]; then
        print_status "$GREEN" "Current Configuration ($CONFIG_FILE):"
        echo
        cat "$CONFIG_FILE"
    else
        print_status "$RED" "No configuration file found at $CONFIG_FILE"
        print_status "$YELLOW" "Run '$0 --interactive' to create one"
    fi
}

# Function to reset configuration
reset_configuration() {
    local reset=$(get_user_choice "Reset configuration to defaults? This will overwrite current settings. (y/N)" "n")
    if [[ "$reset" =~ ^[Yy] ]]; then
        echo "$DEFAULT_CONFIG" > "$CONFIG_FILE"
        chmod 640 "$CONFIG_FILE"
        print_status "$GREEN" "âœ“ Configuration reset to defaults"
    else
        echo "Configuration reset cancelled"
    fi
}

# Main wizard function
run_interactive_wizard() {
    check_root
    display_banner

    print_status "$BLUE" "Welcome to UFW Blocklist Configuration!"
    echo "This wizard will help you configure enhanced firewall blocking."
    echo

    configure_ipset_names
    configure_data_sources
    configure_update_frequencies
    configure_default_strategy
    review_configuration
    save_configuration

    print_status "$GREEN" "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      Configuration Complete!                           â•‘
â•‘                                                                      â•‘
â•‘  Your configuration has been saved to:                                    â•‘
â•‘  $CONFIG_FILE                                                     â•‘
â•‘                                                                      â•‘
â•‘  Next steps:                                                         â•‘
â•‘  1. Run the installation script to apply your configuration            â•‘
â•‘  2. Enable UFW: sudo ufw enable                                â•‘
â•‘  3. Test with: sudo ufw status                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# Main execution logic
case "${1:-interactive}" in
    -h|--help)
        show_usage
        ;;
    -i|--interactive)
        run_interactive_wizard
        ;;
    -s|--show)
        show_configuration
        ;;
    -r|--reset)
        reset_configuration
        ;;
    interactive|"")
        run_interactive_wizard
        ;;
    *)
        print_status "$RED" "Unknown option: $1"
        echo
        show_usage
        exit 1
        ;;
esac