#!/bin/bash
#
# UFW Blocklist Configuration Management System
# Simplified interactive configuration menu.
#

set -e

# Configuration file path
CONFIG_FILE="/etc/default/ufw-blocklist"

# --- Default Configuration ---
load_defaults() {
    THREAT_IPSET="ufw-blocklist-threat"
    GEO_IPSET="ufw-blocklist-cn"
    THREAT_URL="https://raw.githubusercontent.com/stamparm/ipsum/master/levels/3.txt"
    GEO_URL="http://www.ipdeny.com/ipblocks/data/countries/cn.zone"
    ENABLE_THREAT_UPDATE="yes"
    ENABLE_GEO_UPDATE="yes"
    THREAT_UPDATE_FREQ="daily"
    GEO_UPDATE_FREQ="weekly"
    DEFAULT_STRATEGY="conservative"
    LOG_LEVEL="3"
    LOG_PREFIX="[UFW BLOCKLIST]"
}

# --- Load Existing or Default Configuration ---
load_config() {
    load_defaults # Start with defaults
    if [ -f "$CONFIG_FILE" ]; then
        # If config file exists, source it to override defaults
        # This allows existing settings to be loaded.
        # The weird quoting is to prevent shell-expansion during the sourcing.
        # shellcheck source=/dev/null
        . "$CONFIG_FILE"
    fi
}

# --- Functions for Menu Actions ---

check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo "Error: This script must be run as root."
        exit 1
    fi
}

show_current_config() {
    echo "--- Current Configuration ---"
    echo "1. THREAT_IPSET: $THREAT_IPSET"
    echo "2. GEO_IPSET: $GEO_IPSET"
    echo "3. THREAT_URL: $THREAT_URL"
    echo "4. GEO_URL: $GEO_URL"
    echo "5. ENABLE_THREAT_UPDATE: $ENABLE_THREAT_UPDATE"
    echo "6. ENABLE_GEO_UPDATE: $ENABLE_GEO_UPDATE"
    echo "7. THREAT_UPDATE_FREQ: $THREAT_UPDATE_FREQ"
    echo "8. GEO_UPDATE_FREQ: $GEO_UPDATE_FREQ"
    echo "9. DEFAULT_STRATEGY: $DEFAULT_STRATEGY"
    echo "---------------------------"
}

edit_config() {
    local var_name="$1"
    local current_value="${!1}" # Indirect reference
    read -p "Enter new value for $var_name [$current_value]: " new_value
    # If user just presses enter, keep the current value
    if [ -n "$new_value" ]; then
        export "$var_name"="$new_value"
    fi
}

save_configuration() {
    echo "Saving configuration to $CONFIG_FILE..."
    {
        echo "# UFW Blocklist Configuration"
        echo "# Generated by ufw-blocklist-config on $(date)"
        echo ""
        echo "THREAT_IPSET=\"$THREAT_IPSET\""
        echo "GEO_IPSET=\"$GEO_IPSET\""
        echo "THREAT_URL=\"$THREAT_URL\""
        echo "GEO_URL=\"$GEO_URL\""
        echo "ENABLE_THREAT_UPDATE=\"$ENABLE_THREAT_UPDATE\""
        echo "ENABLE_GEO_UPDATE=\"$ENABLE_GEO_UPDATE\""
        echo "THREAT_UPDATE_FREQ=\"$THREAT_UPDATE_FREQ\""
        echo "GEO_UPDATE_FREQ=\"$GEO_UPDATE_FREQ\""
        echo "DEFAULT_STRATEGY=\"$DEFAULT_STRATEGY\""
        echo "LOG_LEVEL=\"$LOG_LEVEL\""
        echo "LOG_PREFIX=\"$LOG_PREFIX\""
    } > "$CONFIG_FILE"
    chmod 640 "$CONFIG_FILE"
    echo "Configuration saved."
}

# --- Main Menu ---
main_menu() {
    while true; do
        echo ""
        echo "UFW Blocklist Configuration"
        show_current_config
        echo "Menu:"
        echo "  e - Edit a configuration value"
        echo "  r - Reset all values to factory defaults"
        echo "  s - Save and exit"
        echo "  q - Quit without saving"
        echo ""
        read -p "Choose an option: " choice

        case "$choice" in
            e)
                read -p "Enter the number of the setting to edit (1-9): " num
                case "$num" in
                    1) edit_config "THREAT_IPSET" ;;
                    2) edit_config "GEO_IPSET" ;;
                    3) edit_config "THREAT_URL" ;;
                    4) edit_config "GEO_URL" ;;
                    5) edit_config "ENABLE_THREAT_UPDATE" ;;
                    6) edit_config "ENABLE_GEO_UPDATE" ;;
                    7) edit_config "THREAT_UPDATE_FREQ" ;;
                    8) edit_config "GEO_UPDATE_FREQ" ;;
                    9) edit_config "DEFAULT_STRATEGY" ;;
                    *) echo "Invalid selection." ;;
                esac
                ;;
            r)
                read -p "Are you sure you want to reset to defaults? (y/N): " confirm
                if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
                    echo "Resetting to defaults..."
                    load_defaults
                else
                    echo "Reset cancelled."
                fi
                ;;
            s)
                save_configuration
                break
                ;;
            q)
                read -p "Are you sure you want to quit without saving? (y/N): " confirm
                if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
                    echo "Exiting without saving."
                    break
                else
                    echo "Cancelled."
                fi
                ;;
            *)
                echo "Invalid option. Please try again."
                ;;
        esac
    done
}

# --- Script Execution ---
check_root
load_config
main_menu

exit 0